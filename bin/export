#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

if [ $# -eq 0 ]
then
	echo "This script exports an entire Scrollytelling account to HTML."
	echo "The export is dumped in HOME for your enjoyment. Don't swallow everything at once."
	echo
	echo "Usage: $0 <account cname>"
	echo "  e.g. $0 stories.example.com"
	echo
	exit 1
fi

set -vx
# Bundler, for Ruby
gem install bundler --conservative
bundle check || bundle install

# NPM, for Node
npm -v
npm install -g npm-check
npm-check

# STEP: query the database and build index.json
${HOME}/Rails/scrollytelling/bin/rails runner step_1_build_index/published_entries.rb $1

# STEP: download HTML and story-specific assets
step_1_build_index/canonical_urls | wget \
  --adjust-extension \
  --convert-links \
  --directory-prefix="${HOME}" \
  --mirror \
  --page-requisites \
  --timestamping \
  --verbose \
  --input-file=- || true

cd $HOME/$1

# STEP: obliterate links to self and yolo every story into a directory.
ls *.html | parallel sed -i 's/{}//g' {}
ls *.html | grep -v 'index.html' | parallel mv {} {.}/index.html

# STEP: sync media bucket
$HOME/scrollytelling-export/step_1_build_index/media_folders "stories.example.com" | xargs -I '{}' aws s3 sync s3://{} {}

# STEP: sync output bucket
$HOME/scrollytelling-export/step_1_build_index/output_folders "stories.example.com" | xargs -I '{}' aws s3 sync s3://storyboard-pageflow-production-out/{} {}

# STEP: unpack static assets.
tar xvfz ../../artifacts/assets.tar.gz scrollytelling.link/
tar xvfz ../../artifacts/output.tar.gz output.scrollytelling.com/
tar xvfz ../../artifacts/root.tar.gz

mkdir -p scrollytelling.link/entries

for file in entries/*; do
  mv "$file" "scrollytelling.link/${file/\?*/}"
done

# STEP: clean the html
ls */index.html | parallel ../../step_2_scrape_media {}
sed -i 's\https://output\/output\g' */index.html
sed -i 's\https://output\/output\g' */*/*.html
sed -i 's\//output\/output\g' scrollytelling.link/**/*.js
sed -i 's\https://media\/media\g' scrollytelling.link/**/*.css
sed -i 's\https://media\/media\g' scrollytelling.link/*/index.html
sed -i 's\http://media\/media\g' scrollytelling.link/*/index.html
sed -i 's\https://scrollytelling\/scrollytelling\g' */index.html
sed -i 's\https://scrollytelling\/scrollytelling\g' */*/*.html
sed -i 's\https://scrollytelling\/scrollytelling\g' scrollytelling.link/**/*.css
sed -i 's\https://scrollytelling\/scrollytelling\g' scrollytelling.link/**/*.js
sed -i 's/ data-turbolinks-track="true"//g' */index.html # no turbolinks either
sed -i 's/href="[a-z-]+\.html/href="/g' */index.html # no turbolinks either

# STEP: remove unwanted artifacts
rm robots.txt
